<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
</head>

<body id="hello">

  <!-- <small>
    Copy html directly into Text box, summarize/convert to MD/HTML, and copy.<br><br>
  </small> -->

  <div id="commands">
    <span style="float: left">
      <button id="tomd-button" class="btn" onclick="toMD('editable', 'md')">To MD</button>
      <button id="tohtml-button" class="btn" onclick="toHTML('editable', 'md')">To HTML</button>
      <button id="copy-button" class="btn" onclick="copyContent('md')">Copy Text</button>
    </span>
    <span style="float: right">
      <button class="btn" id="paste-button" onclick="pasteIn('editable')">Paste</button>
      <button class="btn" id="summarize-button" onclick="summ('editable')">Summarize</button>
      <button class="btn" onclick="reload('')">Reset</button>
    </span>

  </div>
  <div id="content">
    <div contenteditable="true" id="editable">

    </div>
    <textarea id="md"></textarea>
  </div>


  <script src="lodash.js"></script>
  <script src="turndown.js"></script>
  <script src="summarize.js"></script>
  <script>


    function summ(id) {
      var text = document.getElementById(id).innerText;

      var keywords = getKeyWords(text);
      console.log(keywords);

      text = text.replaceAll("\n\n", "\n");
      text = text.replaceAll("\n\n", "\n");
      text = text.replaceAll("\n\n", "\n");
      text = text.replaceAll("\n", "||");
      // text = text.replaceAll(". ", ".||");
      // text = text.replaceAll(".\n", ".||\n");
      // text = text.replaceAll("? ", "?||");
      // text = text.replaceAll("?\n", "?||\n");
      // text = text.replaceAll("! ", "!||");
      // text = text.replaceAll("!\n", "!||\n");
      text = text.replaceAll("\n", "");

      var sentences = text.split("||");

      for (var i = 0; i < sentences.length; i++) {
        var x = 0;
        for (var j = 0; j < keywords.length; j++) {
          // 
          var n = sentences[i].search(keywords[j]);
          if(n >= 0) x++;
        }
        if (x == 0) sentences.splice(i, 1); //TODO: rank sentences based on how many keywords they have
      } 

      sentences = getRandomMembers(sentences, 3);

      disable('summarize-button');
      var copyBtn = document.getElementById('summarize-button');
      copyBtn.innerText = "Summ'd!"
      document.getElementById(id).innerText = sentences.join("\n\n");;
      sentences = null;
    }



    var suffixes = ["n't", "'s", "'ve", "'d"];
    var commonWords = ['i', 'me', 'my', 'myself', 'we', 'our', 'ours', 'ourselves', 'you', 'your', 'yours', 'yourself', 'yourselves', 'he', 'him', 'his', 'himself', 'she', 'her', 'hers', 'herself', 'it', 'its', 'itself', 'they', 'them', 'their', 'theirs', 'themselves', 'what', 'which', 'who', 'whom', 'this', 'that', 'these', 'those', 'am', 'is', 'are', 'was', 'were', 'be', 'been', 'being', 'have', 'has', 'had', 'having', 'do', 'does', 'did', 'doing', 'a', 'an', 'the', 'and', 'but', 'if', 'or', 'because', 'as', 'until', 'while', 'of', 'at', 'by', 'for', 'with', 'about', 'against', 'between', 'into', 'through', 'during', 'before', 'after', 'above', 'below', 'to', 'from', 'up', 'down', 'in', 'out', 'on', 'off', 'over', 'under', 'again', 'further', 'then', 'once', 'here', 'there', 'when', 'where', 'why', 'how', 'all', 'any', 'both', 'each', 'few', 'more', 'most', 'other', 'some', 'such', 'no', 'nor', 'not', 'only', 'own', 'same', 'so', 'than', 'too', 'very', 'can', 'will', 'just', 'should', 'now', "ai", 'ma', 'say', 'said', 'would'];

    function getKeyWords(string, num = 5) {
      
      string = string.replace(/[0-9]/gi, '');
      string = string.replace(/[^\'\w\s]/gi, '');
      string = string.replace("\n", ' ');
      string = string.replaceAll("  ", " ");

      for (var i = 0; i < commonWords.length; i++) {
        string = string.replaceAll(" " + commonWords[i] + " ", " ");
        string = string.replaceAll(" " + commonWords[i] + ".", " ");
      }
      for (var i = 0; i < suffixes.length; i++) {
        string = string.replaceAll(suffixes[i] + " ", " ");
      }

      var array = string.split(" ");

      var map = array.reduce(function (p, c) {
        p[c] = (p[c] || 0) + 1;
        return p;
      }, {});

      var array2 = Object.keys(map).sort(function (a, b) {
        return map[b] - map[a];
      });

      return (array2.slice(0, num));
    }

    function getRandomMembers2(arr, n) {
      const shuffled = arr.sort(() => 0.5 - Math.random());
      let result = shuffled.slice(0, n);
      return result;
    }

    function getRandomMembers(arr, n) {
      var arr2 = [];
      var maxLen = Math.max(0, ...arr.map(s => s.length));

      for (var a = 0; a < arr.length; a++) {
        var len = arr[a].length;
        if (len > maxLen / 2) {
          arr2.push(arr[a]);
        }
      }


      if (arr2.length <= n)
        return arr2;

      var x = [];
      while (x.length < n) {
        var r = Math.floor(Math.random() * arr2.length);
        if (x.indexOf(r) === -1) x.push(r);
      }
      x = x.sort(function (a, b) { return a - b });
      res = [];
      for (var i = 0; i < x.length; i++) {
        res.push("- " + arr2[x[i]]);
      }
      return (res);
    }

    function getLongMembers(arr, n) {
      // console.log(arr, n);
      const ordered = arr.sort((a, b) => b.length - a.length);
      let result = ordered.slice(0, n);
      return result;
    }


    hide('md');
    hide('copy-button');

    function reload() {
      location.reload();
    }

    function toHTML(inId, outId) {
      var input = document.getElementById(inId);
      var output = document.getElementById(outId);
      var html = input.innerHTML;
      input.innerText = html;
      output.value = html;
      hide('tohtml-button');
      hide('tomd-button');
      show('copy-button');
      hide('editable');
      show('md');
    }

    function toMD(inId, outId) {
      var input = document.getElementById(inId);
      var output = document.getElementById(outId);
      var turndownService = new window.TurndownService({
        "headingStyle": "atx",
        "hr": "- - -",
        "bulletListMarker": "-",
        "codeBlockStyle": "indented",
        "fence": "```",
        "emDelimiter": "*",
        "strongDelimiter": "**",
        "linkStyle": "inlined",
        "linkReferenceStyle": "full"
      });

      var tables = turndownPluginGfm.tables
      turndownService.use([tables])
      markdown = turndownService.turndown(input.innerHTML)
      input.innerText = markdown;
      output.value = markdown;
      hide('tohtml-button');
      hide('tomd-button');
      show('copy-button');
      hide('editable');
      show('md');
    }

    function copyContent(id) {
      let elem = document.getElementById(id);
      elem.select();
      document.execCommand("copy");
      disable('copy-button');
      var copyBtn = document.getElementById('copy-button');
      copyBtn.innerText = "Copied!"
    }

    function pasteIn(id) {
      navigator.clipboard.readText('text/html').then(
        content => document.getElementById(id).innerText += content
      );
      disable('paste-button');
      var pasteBtn = document.getElementById('paste-button');
      pasteBtn.innerText = "Pasted!"
    }

    function show(id) {
      document.getElementById(id).style.display = '';
    }
    function hide(id) {
      document.getElementById(id).style.display = 'none';
    }
    function enable(id) {
      document.getElementById(id).disabled = false;
    }
    function disable(id) {
      document.getElementById(id).disabled = true;
    }

  </script>

  <style>
    * {
      font-family: system-ui;
      box-sizing: border-box;
      padding: 0;
      margin: 0;
    }

    body {
      padding: 0.5em;
    }

    #editable,
    #md {
      background-color: #eee;
      padding: 0.75em;
      height: 450px;
      font-size: 0.8em;
      overflow: scroll;
      width: 100%;
      border: 1px solid #aaa;
      display: block;
    }

    .btn {
      padding: 0.75em;
      background: #ccc;
      border: 1px solid #777;
      border-radius: 3px;
      margin-bottom: 0.75em;
    }

    #commands {
      position: fixed;
      width: 100%;
      left: 0;
      right: 0;
      padding: 0 0.5em;
      background: white;
      border-bottom: 1px solid;
    }

    #content {
      margin-top: 3.5em;
    }
  </style>

</body>

</html>
